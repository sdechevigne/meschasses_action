name: ü§ñ Build & Deploy Android

on:
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ========================================
      # 1Ô∏è‚É£ CHECKOUT - MODIFI√â
      # ========================================
      - name: üì• Checkout React code from meschasse_mobile
        uses: actions/checkout@v4
        with:
          repository: sdechevigne/meschasse_mobile
          token: ${{ secrets.CI_PAT_TOKEN }}
          path: app

      - name: üì• Checkout native Android from meschasses_natives
        uses: actions/checkout@v4
        with:
          repository: sdechevigne/meschasses_natives
          token: ${{ secrets.CI_PAT_TOKEN }}
          path: native
          sparse-checkout: |
            android
            whatsnew

      - name: üìÇ Copy Android platform to app
        run: |
          echo "üìã Copying android/ from native repo..."
          cp -r native/android app/
          echo "üìã Copying whatsnew/ if exists..."
          if [ -d native/whatsnew ]; then
            cp -r native/whatsnew app/
          else
            echo "‚ö†Ô∏è whatsnew/ directory not found, skipping"
          fi
          echo "‚úÖ Native platform copied"
          ls -la app/

      # ========================================
      # 2Ô∏è‚É£ SETUP - INCHANG√â
      # ========================================
      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ‚òï Setup Java (JDK 21 pour Capacitor 7)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - name: üîß Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          ndk-version: '26.1.10909125'

      - name: üíæ Cache Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false

      # ========================================
      # 3Ô∏è‚É£ BUILD WEB & CONFIG - INCHANG√â
      # ========================================
      - name: üìö Install dependencies
        run: |
          cd app
          rm -rf node_modules package-lock.json
          npm install

      - name: üèóÔ∏è Build web app
        run: |
          cd app
          npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_POSTHOG_KEY: ${{ secrets.VITE_POSTHOG_KEY }}

      - name: üì± Sync Capacitor Android
        run: |
          cd app
          npx cap sync android

      - name: üîê Fix gradlew permissions
        run: chmod +x app/android/gradlew

      # ========================================
      # 4Ô∏è‚É£ CONFIGURE KEYSTORE & SIGNING - CORRIG√â
      # ========================================
      - name: üîë Create Keystore from Secret
        run: |
          echo "üìÇ Creating keystore at expected location..."
          mkdir -p app/android/app
      
          echo "${{ secrets.ANDROID_KEYSTORE_FILE }}" | base64 --decode > app/android/app/keystore
      
          chmod 600 app/android/app/keystore
      
          echo "‚úÖ Keystore created:"
          ls -l app/android/app/keystore
      
      # ========================================
      # 5Ô∏è‚É£ CONFIGURE GRADLE BUILD - MODIFI√â
      # ========================================
      - name: üîß Configure local.properties
        run: |
          cd app/android
          cat > local.properties << EOF
          sdk.dir=${ANDROID_SDK_ROOT}
          ndk.dir=${ANDROID_NDK_ROOT}
          EOF
          echo "‚úÖ local.properties configur√©"
      
      - name: üî¢ Verify Version Configuration
        run: |
          cd app
          VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"\([^"]*\)".*/\1/')
          BUILD_NUMBER="${{ github.run_number }}"
          
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          VERSION_CODE=$((MAJOR * 1000000 + MINOR * 1000 + PATCH * 10 + BUILD_NUMBER))
          VERSION_NAME="$VERSION-build.$BUILD_NUMBER"
          
          echo "üì± Version calcul√©e (automatique via build.gradle):"
          echo "  ‚Ä¢ package.json version: $VERSION"
          echo "  ‚Ä¢ Build number: $BUILD_NUMBER"
          echo "  ‚Ä¢ versionCode: $VERSION_CODE"
          echo "  ‚Ä¢ versionName: $VERSION_NAME"
          
      # ========================================
      # 6Ô∏è‚É£ SETUP FIREBASE - INCHANG√â
      # ========================================
      - name: üî• Setup Firebase Config
        run: |
          cd app/android
          if [ -z "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" ]; then
            echo "‚ö†Ô∏è Google Services JSON secret not found"
          else
            echo "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
            echo "‚úÖ google-services.json configur√©"
          fi

      # ========================================
      # 7Ô∏è‚É£ BUILD ANDROID APP - INCHANG√â
      # ========================================
      
      - name: üî® Build Release Bundle (AAB)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd app/android
      
          ./gradlew bundleRelease \
            -PKEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -PKEY_ALIAS="$KEY_ALIAS" \
            -PKEY_PASSWORD="$KEY_PASSWORD" \
            --stacktrace \
            2>&1 | tee build.log
      
          grep -q "BUILD SUCCESSFUL" build.log
      
      - name: üîê Build & Sign APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd app/android
      
          ./gradlew assembleRelease \
            -PKEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -PKEY_ALIAS="$KEY_ALIAS" \
            -PKEY_PASSWORD="$KEY_PASSWORD" \
            --stacktrace

      # ========================================
      # 8Ô∏è‚É£ PUBLISH TO GOOGLE PLAY STORE - INCHANG√â
      # ========================================
      - name: üöÄ Upload to Google Play Draft
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: 'app/android/app/build/outputs/bundle/release/app-release.aab'
          track: internal
          inAppUpdatePriority: 5
          status: draft
          whatsNewDirectory: app/whatsnew

      # ========================================
      # 9Ô∏è‚É£ CLEANUP & NOTIFICATION - ZERO TRACE
      # ========================================
      - name: üì± GitHub Notification - SUCCESS
        if: success()
        run: |
          BUILD_NUMBER="${{ github.run_number }}"
          BUILD_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "üéâ Android Build #$BUILD_NUMBER uploaded to Google Play Store"
          echo "üì¶ Status: Draft (internal track)"
          echo "üîó Workflow: $BUILD_URL"

      - name: üóëÔ∏è DELETE RUN - No Trace Left
        if: success()
        run: |
          echo "üóëÔ∏è Deleting this run to leave no trace..."
          sleep 5
          gh run delete ${{ github.run_id }} --repo ${{ github.repository }}
          echo "‚úÖ Run deleted - zero public history"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: üî¥ KEEP RUN for debugging - FAILED
        if: failure()
        run: |
          echo "üî¥ Build failed - run preserved for investigation"
          echo "üìã Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"


