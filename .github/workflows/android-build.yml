name: ğŸ¤– Build & Deploy Android

on:
  workflow_dispatch:

concurrency:
  group: android-build
  cancel-in-progress: false

jobs:
  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      actions: write

    steps:
      # ========================================
      # 0ï¸âƒ£ SECURITY - Mask sensitive data
      # ========================================
      - name: ğŸ” Setup environment masking
        run: |
          echo "::add-mask::${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
          echo "::add-mask::${{ secrets.ANDROID_KEY_PASSWORD }}"
          echo "::add-mask::${{ secrets.ANDROID_PACKAGE_NAME }}"
          echo "ğŸ” Secrets masked in logs"

      # ========================================
      # 1ï¸âƒ£ CHECKOUT
      # ========================================
      - name: ğŸ“¥ Checkout React code from meschasse_mobile
        uses: actions/checkout@v4
        with:
          repository: sdechevigne/meschasse_mobile
          token: ${{ secrets.CI_PAT_TOKEN }}
          path: app

      - name: ğŸ“¥ Checkout native Android from meschasses_natives
        uses: actions/checkout@v4
        with:
          repository: sdechevigne/meschasses_natives
          token: ${{ secrets.CI_PAT_TOKEN }}
          path: native
          sparse-checkout: |
            android
            whatsnew

      - name: ğŸ“‚ Copy Android platform to app
        run: |
          echo "ğŸ“‹ Copying android/ from native repo..."
          cp -r native/android app/
          if [ -d native/whatsnew ]; then
            cp -r native/whatsnew app/
          else
            echo "âš ï¸ whatsnew/ directory not found, skipping"
          fi
          echo "âœ… Native platform copied"

      # ========================================
      # 2ï¸âƒ£ SETUP
      # ========================================
      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: â˜• Setup Java (JDK 21 pour Capacitor 7)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          ndk-version: '26.1.10909125'

      - name: ğŸ’¾ Cache Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false

      # ========================================
      # 3ï¸âƒ£ BUILD WEB & CONFIG
      # ========================================
      - name: ğŸ“š Install dependencies
        run: |
          cd app
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ—ï¸ Build web app
        run: |
          cd app
          npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_POSTHOG_KEY: ${{ secrets.VITE_POSTHOG_KEY }}

      - name: ğŸ“± Sync Capacitor Android
        run: |
          cd app
          npx cap sync android

      - name: ğŸ” Fix gradlew permissions
        run: chmod +x app/android/gradlew

      # ========================================
      # 4ï¸âƒ£ CONFIGURE KEYSTORE & SIGNING - FIXED
      # ========================================
      - name: ğŸ”‘ Create Keystore from Secret
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd app/android
          mkdir -p app

          # Decode keystore WITHOUT logging
          echo "${{ secrets.ANDROID_KEYSTORE_FILE }}" | base64 --decode > app/release.keystore 2>/dev/null
          
          # Verify file exists
          if [ ! -f app/release.keystore ]; then
            echo "âŒ Failed to create keystore"
            exit 1
          fi
          
          # Set restrictive permissions (600 = rw-------)
          chmod 600 app/release.keystore
          echo "âœ… Keystore created with secure permissions (600)"

          # Create fresh gradle.properties
          if [ -f gradle.properties ]; then
            mv gradle.properties gradle.properties.bak
            echo "ğŸ“¦ Backed up old gradle.properties"
          fi

          # âœ… Config gradle.properties - APPEND safely
          # ğŸ‘‡ FORCER LE SAUT DE LIGNE AVANT D'AJOUTER ğŸ‘‡
          echo "" >> gradle.properties 2>/dev/null || true

          cat >> gradle.properties << 'EOF'
# AndroidX
android.useAndroidX=true
android.enableJetifier=true

# Keystore Configuration
KEYSTORE_FILE=app/release.keystore
KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD
KEY_ALIAS=$KEY_ALIAS
KEY_PASSWORD=$KEY_PASSWORD
EOF

          echo "âœ… gradle.properties configured"

      - name: ğŸ”§ Fix Keystore Path in build.gradle
        run: |
          cd app/android/app
          
          echo "ğŸ“‹ Checking current keystore path..."
          if grep -q "app/app/release.keystore" build.gradle 2>/dev/null; then
            echo "âš ï¸ Found duplicate 'app/app/release.keystore' - fixing..."
            sed -i 's|app/app/release.keystore|app/release.keystore|g' build.gradle
            echo "âœ… Fixed keystore path in build.gradle"
          else
            echo "âœ… Keystore path is correct"
          fi

      - name: ğŸ” Verify Keystore
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        run: |
          cd app/android
          if [ ! -f app/release.keystore ]; then
            echo "âŒ Keystore file not found!"
            exit 1
          fi
          
          # Silent verification - no output
          keytool -list -v \
            -keystore app/release.keystore \
            -storepass "$KEYSTORE_PASSWORD" \
            -alias "${{ secrets.ANDROID_KEY_ALIAS }}" > /dev/null 2>&1
          
          if [ $? -eq 0 ]; then
            echo "âœ… Keystore verified successfully"
          else
            echo "âŒ Keystore verification failed"
            exit 1
          fi

      # ========================================
      # 5ï¸âƒ£ CONFIGURE GRADLE BUILD
      # ========================================
      - name: ğŸ”§ Configure local.properties
        run: |
          cd app/android
          cat > local.properties << EOF
          sdk.dir=${ANDROID_SDK_ROOT}
          ndk.dir=${ANDROID_NDK_ROOT}
          EOF
          echo "âœ… local.properties configurÃ©"

      - name: ğŸ”¢ Update App Version
        run: |
          cd app/android/app
          VERSION=$(grep '"version"' ../../package.json | head -1 | sed 's/.*"\([^"]*\)".*/\1/')
          BUILD_NUMBER="${{ github.run_number }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          VERSION_CODE=$((MAJOR * 1000000 + MINOR * 1000 + PATCH * 10 + BUILD_NUMBER))
          VERSION_NAME="$VERSION-build.$BUILD_NUMBER"

          if [ -f build.gradle ]; then
            sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" build.gradle
            sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION_NAME\"/" build.gradle
            echo "âœ… build.gradle mis Ã  jour"
          fi

          echo "âœ… Version: $VERSION_CODE / $VERSION_NAME"

      # ========================================
      # 6ï¸âƒ£ SETUP FIREBASE
      # ========================================
      - name: ğŸ”¥ Setup Firebase Config
        run: |
          cd app/android
          if [ -z "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" ]; then
            echo "âš ï¸ Google Services JSON secret not found"
          else
            echo "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json 2>/dev/null
            chmod 600 app/google-services.json
            echo "âœ… google-services.json configured (permissions: 600)"
          fi

      # ========================================
      # 7ï¸âƒ£ BUILD ANDROID APP
      # ========================================
      - name: ğŸ”¨ Build Release Bundle (AAB)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd app/android

          ./gradlew bundleRelease \
            -DKEYSTORE_FILE=app/release.keystore \
            -DKEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -DKEY_ALIAS="$KEY_ALIAS" \
            -DKEY_PASSWORD="$KEY_PASSWORD" \
            -PsignedBuildType=release \
            --stacktrace \
            2>&1 | grep -v "KEYSTORE_PASSWORD\|KEY_PASSWORD" | tee build.log

          if grep -q "BUILD SUCCESSFUL" build.log; then
            echo "âœ… AAB build successful"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: ğŸ” Build & Sign APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd app/android

          ./gradlew assembleRelease \
            -DKEYSTORE_FILE=app/release.keystore \
            -DKEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -DKEY_ALIAS="$KEY_ALIAS" \
            -DKEY_PASSWORD="$KEY_PASSWORD" \
            -PsignedBuildType=release \
            --stacktrace 2>&1 | grep -v "KEYSTORE_PASSWORD\|KEY_PASSWORD"

      # ========================================
      # 8ï¸âƒ£ PUBLISH TO GOOGLE PLAY STORE
      # ========================================
      - name: ğŸš€ Upload to Google Play Draft
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: 'app/android/app/build/outputs/bundle/release/app-release.aab'
          track: internal
          inAppUpdatePriority: 5
          status: draft
          whatsNewDirectory: app/whatsnew

      # ========================================
      # 9ï¸âƒ£ CLEANUP & SECURITY
      # ========================================
      - name: ğŸ§¹ Cleanup sensitive files
        if: always()
        run: |
          cd app/android
          # Securely delete keystore
          if [ -f app/release.keystore ]; then
            shred -vfz -n 10 app/release.keystore 2>/dev/null || rm -f app/release.keystore
            echo "ğŸ§¹ Keystore securely deleted"
          fi
          
          # Delete backup
          if [ -f gradle.properties.bak ]; then
            rm -f gradle.properties.bak
          fi
          
          # Delete google-services.json
          if [ -f app/google-services.json ]; then
            shred -vfz -n 10 app/google-services.json 2>/dev/null || rm -f app/google-services.json
            echo "ğŸ§¹ Google Services config deleted"
          fi

      - name: ğŸ“± GitHub Notification - SUCCESS
        if: success()
        run: |
          BUILD_NUMBER="${{ github.run_number }}"
          echo "ğŸ‰ Android Build #$BUILD_NUMBER uploaded to Google Play Store (DRAFT)"
          echo "ğŸ“¦ Status: Draft (internal track - ready for testing)"

      - name: ğŸ—‘ï¸ DELETE RUN - No Public Trace
        if: success()
        run: |
          echo "ğŸ—‘ï¸ Deleting workflow run to hide build artifacts..."
          sleep 5
          gh run delete ${{ github.run_id }} --repo ${{ github.repository }}
          echo "âœ… Run deleted - zero public history"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: ğŸ”´ KEEP RUN for debugging - FAILED
        if: failure()
        run: |
          echo "ğŸ”´ Build failed - run preserved for investigation"
          echo "ğŸ“‹ Check logs for errors"
