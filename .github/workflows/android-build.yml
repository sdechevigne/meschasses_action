name: ü§ñ Build & Deploy Android

on:
  workflow_dispatch:

concurrency:
  group: android-build
  cancel-in-progress: false

jobs:
  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      actions: write

    steps:
      # ========================================
      # 0Ô∏è‚É£ SECURITY - Mask sensitive data
      # ========================================
      - name: üîê Setup environment masking
        run: |
          echo "::add-mask::${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
          echo "::add-mask::${{ secrets.ANDROID_KEY_PASSWORD }}"
          echo "::add-mask::${{ secrets.ANDROID_PACKAGE_NAME }}"

      # ========================================
      # 1Ô∏è‚É£ CHECKOUT & SETUP
      # ========================================
      - name: üì• Checkout React code
        uses: actions/checkout@v4
        with:
          repository: sdechevigne/meschasse_mobile
          token: ${{ secrets.CI_PAT_TOKEN }}
          path: app

      - name: üì• Checkout Native Android
        uses: actions/checkout@v4
        with:
          repository: sdechevigne/meschasses_natives
          token: ${{ secrets.CI_PAT_TOKEN }}
          path: native
          sparse-checkout: |
            android
            whatsnew

      - name: üìÇ Copy Android platform
        run: |
          cp -r native/android app/
          if [ -d native/whatsnew ]; then
            cp -r native/whatsnew app/
          fi

      - name: üì¶ Setup Tools (Node 20 & JDK 21)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - name: üîß Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          ndk-version: '26.1.10909125'

      # ========================================
      # 3Ô∏è‚É£ BUILD WEB
      # ========================================
      - name: üìö Install & Build Web
        run: |
          cd app
          npm install
          npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_POSTHOG_KEY: ${{ secrets.VITE_POSTHOG_KEY }}

      - name: üì± Sync Capacitor
        run: |
          cd app
          npx cap sync android
          chmod +x android/gradlew

      # ========================================
      # 4Ô∏è‚É£ CONFIGURE KEYSTORE (M√©thode Robuste)
      # ========================================
      - name: üîë Create Keystore & Config
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd app/android
          mkdir -p app

          # 1. Cr√©ation du fichier physique
          echo "${{ secrets.ANDROID_KEYSTORE_FILE }}" | base64 --decode > release.keystore
          
          # 2. Configuration Gradle (Avec cat << EOF pour la s√©curit√©)
          # Note: On utilise 'release.keystore' comme dans votre version qui fonctionnait
          cat >> gradle.properties << EOF
          
          # Optimisations
          android.useAndroidX=true
          android.enableJetifier=true
          
          # Signing Config
          KEYSTORE_FILE=release.keystore
          KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD
          KEY_ALIAS=$KEY_ALIAS
          KEY_PASSWORD=$KEY_PASSWORD
          EOF
          
          echo "‚úÖ Keystore & Config created"

      # ========================================
      # 5Ô∏è‚É£ BUILD (AAB UNIQUEMENT)
      # ========================================
      - name: üî® Build Release Bundle (AAB)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -o pipefail # Arr√™te le script si Gradle √©choue
          cd app/android

          # On utilise juste bundleRelease. On NE FAIT PAS assembleRelease pour √©conomiser la RAM.
          ./gradlew bundleRelease \
            -DKEYSTORE_FILE=release.keystore \
            -DKEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -DKEY_ALIAS="$KEY_ALIAS" \
            -DKEY_PASSWORD="$KEY_PASSWORD" \
            -PsignedBuildType=release \
            --stacktrace \
            2>&1 | grep -v "KEYSTORE_PASSWORD\|KEY_PASSWORD"

          echo "‚úÖ Build AAB Termin√©"

      # ========================================
      # 8Ô∏è‚É£ PUBLISH & CLEANUP
      # ========================================
      - name: üöÄ Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: 'app/android/app/build/outputs/bundle/release/app-release.aab'
          track: internal
          status: draft
          whatsNewDirectory: app/whatsnew

      - name: üßπ Cleanup & Delete Run
        if: always()
        run: |
          cd app/android
          rm -f release.keystore gradle.properties
          
          echo "üóëÔ∏è Deleting workflow run..."
          sleep 5
          gh run delete ${{ github.run_id }} --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.CI_PAT_TOKEN }}


