name: üîç Test App Store Secrets

on:
  workflow_dispatch:

jobs:
  test-secrets:
    name: Verify App Store API Credentials
    runs-on: macos-15
    timeout-minutes: 10

    steps:
      - name: üîç Check Secret Lengths
        run: |
          echo "üîç === Checking Secrets ==="
          echo ""
          
          ISSUER_LEN=${#ISSUER_ID}
          KEY_ID_LEN=${#API_KEY_ID}
          PRIV_KEY_LEN=${#API_PRIVATE_KEY}
          
          echo "APPSTORE_ISSUER_ID length: $ISSUER_LEN"
          echo "APPSTORE_API_KEY_ID length: $KEY_ID_LEN"
          echo "APPSTORE_API_PRIVATE_KEY length: $PRIV_KEY_LEN"
          echo ""
          
          if [ $ISSUER_LEN -lt 30 ]; then
            echo "‚ö†Ô∏è WARNING: ISSUER_ID seems too short (expected ~36)"
          fi
          
          if [ $KEY_ID_LEN -lt 8 ]; then
            echo "‚ö†Ô∏è WARNING: API_KEY_ID seems too short (expected 10)"
          fi
          
          if [ $PRIV_KEY_LEN -lt 100 ]; then
            echo "‚ö†Ô∏è WARNING: PRIVATE_KEY seems too short (expected 1000+)"
          fi
        env:
          ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: üîê Verify Private Key Format
        run: |
          echo "üîç === Checking Private Key Format ==="
          echo ""
          
          # Create temp file
          echo "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" > /tmp/test_key.p8
          
          echo "File size: $(wc -c < /tmp/test_key.p8) bytes"
          echo ""
          
          # Check for BEGIN/END markers
          if grep -q "BEGIN PRIVATE KEY" /tmp/test_key.p8; then
            echo "‚úÖ Contains 'BEGIN PRIVATE KEY'"
          else
            echo "‚ùå Missing 'BEGIN PRIVATE KEY'"
          fi
          
          if grep -q "END PRIVATE KEY" /tmp/test_key.p8; then
            echo "‚úÖ Contains 'END PRIVATE KEY'"
          else
            echo "‚ùå Missing 'END PRIVATE KEY'"
          fi
          
          echo ""
          echo "First 5 lines:"
          head -5 /tmp/test_key.p8
          echo ""
          echo "Last 3 lines:"
          tail -3 /tmp/test_key.p8
          echo ""
          
          # Try to read key with openssl
          if openssl pkey -in /tmp/test_key.p8 -text -noout &>/dev/null; then
            echo "‚úÖ OpenSSL can read the key successfully"
          else
            echo "‚ùå OpenSSL CANNOT read the key - it's INVALID"
            echo ""
            echo "OpenSSL error:"
            openssl pkey -in /tmp/test_key.p8 -text -noout 2>&1 || true
          fi
          
          rm -f /tmp/test_key.p8

      - name: üîê Test altool with the key
        run: |
          echo "üîç === Testing altool ==="
          echo ""
          
          # Create private_keys directory structure
          mkdir -p ~/.appstoreconnect/private_keys
          
          KEY_ID="${{ secrets.APPSTORE_API_KEY_ID }}"
          echo "Creating key file: AuthKey_${KEY_ID}.p8"
          
          # Write the key
          echo "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${KEY_ID}.p8
          
          # Verify file was created
          if [ -f ~/.appstoreconnect/private_keys/AuthKey_${KEY_ID}.p8 ]; then
            echo "‚úÖ Key file created"
            echo "File size: $(wc -c < ~/.appstoreconnect/private_keys/AuthKey_${KEY_ID}.p8) bytes"
          else
            echo "‚ùå Key file NOT created"
            exit 1
          fi
          
          echo ""
          echo "Attempting to list keychain with altool..."
          
          xcrun altool --output-format xml \
            --list-providers \
            --apiKeyId "${KEY_ID}" \
            --apiIssuer "${{ secrets.APPSTORE_ISSUER_ID }}" \
            2>&1 | tee altool_output.xml
          
          echo ""
          if grep -q "product-errors" altool_output.xml; then
            echo "‚ùå altool returned errors"
            grep -A 5 "product-errors" altool_output.xml
          else
            echo "‚úÖ altool accepted the credentials"
          fi
          
          # Cleanup
          rm -f ~/.appstoreconnect/private_keys/AuthKey_${KEY_ID}.p8
